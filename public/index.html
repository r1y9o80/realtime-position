<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マイクラプレイヤーデータ</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</head>

<body>
    <table>
        <thead>
            <tr>
                <td>プレイヤーId</td>
                <td>プレイヤー名</td>
                <td>ポジション</td>
            </tr>
        </thead>
        <tbody id="playerData">
            <!-- プレイヤーデータがここに動的に追加される -->
        </tbody>
    </table>
</body>

<script>
    const tbody = document.getElementById('playerData');
    const ws = new WebSocket('wss://realtime-position-15b78e5f6699.herokuapp.com');

    ws.onmessage = async (event) => {
        console.log("データが来ました");
        try {
            const receivedData = event.data; // Blob 型
            console.log("Blobデータを確認しました:", receivedData);

            // Blob を ArrayBuffer に変換
            const arrayBuffer = await receivedData.arrayBuffer();
            console.log("ArrayBufferに変換:", arrayBuffer);

            // ArrayBuffer を Uint8Array に変換
            const uint8Array = new Uint8Array(arrayBuffer);
            
            let ungzip;
            try {
                // Gzip 解凍を試みる
                ungzip = pako.ungzip(uint8Array, { to: 'string' });
                console.log("解凍したデータ（gzip）:", ungzip);
            } catch (gzipError) {
                // gzip で解凍できなければ、deflate 解凍を試みる
                console.error("gzip解凍エラー:", gzipError);
                ungzip = pako.inflate(uint8Array, { to: 'string' });
                console.log("解凍したデータ（deflate）:", ungzip);
            }

            // JSONとしてパース
            const data = JSON.parse(ungzip);
            updateTable(data);

        } catch (error) {
            console.error("データ処理エラー:", error);
            if (error instanceof SyntaxError) {
                console.error("JSONパースエラー:", error.message);
            } else if (error instanceof TypeError) {
                console.error("型エラー:", error.message);
            } else {
                console.error("その他のエラー:", error);
            }
            console.error("エラースタック:", error.stack);
        }
    };


    // テーブルを更新する関数
    function updateTable(data) {
        tbody.innerHTML = ''; // 現在のテーブルの内容をクリア
        Object.entries(data).forEach(([Key, element]) => {
            const { Name, Posi } = element;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${Key}</td>
                <td>${Name}</td>
                <td>${JSON.stringify(Posi)}</td>
            `;
            tbody.appendChild(tr); // 行をテーブルに追加
        });
    }
</script>

</html>
