<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マイクラプレイヤーデータ</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</head>

<body>
    <table>
        <thead>
            <tr>
                <td>プレイヤーId</td>
                <td>プレイヤー名</td>
                <td>ポジション</td>
            </tr>
        </thead>
        <tbody id="playerData">
            <!-- プレイヤーデータがここに動的に追加される -->
        </tbody>
    </table>
</body>

<script>
    const tbody = document.getElementById('playerData');
    const ws = new WebSocket('wss://realtime-position-15b78e5f6699.herokuapp.com');

    // サーバーからデータを受信
    ws.onmessage = async (event) => {
        console.log("データが来ました")
        try {
            // イベントデータがgzip圧縮されている場合とそうでない場合を判定
            const receivedData = event.data
            console.log("圧縮データを確認しました")
            console.log(receivedData)
            const ungzip = pako.ungzip(receivedData, { to: 'string' })
            const data = JSON.parse(ungzip);
            updateTable(data);
        } catch (error) {
        // エラーの詳細をログに出力
        console.error("エラー発生:", error);
        
        // エラーが発生した場所と内容をより詳細に出力
        if (error instanceof SyntaxError) {
            console.error("JSONパースエラー:", error.message);
        } else if (error instanceof TypeError) {
            console.error("型エラー:", error.message);
        } else {
            console.error("その他のエラー:", error);
        }
        
        // エラーのスタックトレース（どこで発生したかの詳細）
        console.error("エラースタック:", error.stack);
    }

    };

    // テーブルを更新する関数
    function updateTable(data) {
        tbody.innerHTML = ''; // 現在のテーブルの内容をクリア
        Object.entries(data).forEach(([Key, element]) => {
            const { Name, Posi } = element;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${Key}</td>
                <td>${Name}</td>
                <td>${JSON.stringify(Posi)}</td>
            `;
            tbody.appendChild(tr); // 行をテーブルに追加
        });
    }
</script>

</html>
